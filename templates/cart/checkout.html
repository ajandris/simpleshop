{% extends '_base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/checkout.css' %}">
{% endblock extra_css %}

{% block content %}

<header class="w3-bar w3-border-bottom">
    <a href="{% url 'cart' %}" class="w3-bar-item w3-button">
        <i class="fa-solid fa-arrow-left background-color-inherit"></i> Back to Cart</a>
    <span class="w3-bar-item w3-right w3-large"><i class="fa-solid fa-credit-card"></i> Checkout</span>
</header>

{% if not cart_items %}
<div class="w3-panel">
    <h3 class="w3-margin-0 w3-center">Cart is empty</h3>
</div>
{% else %}

<div class="w3-content page w3-padding-16">
    <div class="w3-row-padding">

        <!-- Checkout Form Section -->
        <section class="w3-col l8 m12 s12">

            <!-- Shipping Address -->
            <div class="w3-card w3-white w3-margin-bottom">
                <header class="w3-container w3-padding">
                    <h3 class="w3-margin-0">Shipping and Billing Address</h3>
                </header>
                {% if addresses|length >= 2 %}
                <div class="w3-container">
                    <div class="w3-row-padding">
                    <form action="{%  url 'checkout' %}" method="post">
                    {% csrf_token %}
                        <select name="active_address_id" class="wide">
                            {% for addr in addresses %}
                                <option value="{{ addr.id}}"{% if addr.id == active_address.id %} selected{% endif %}>
                                    {{ addr.address_line1 }}
                                    {{ addr.address_line2 }},
                                    {{ addr.city }},
                                    {% if addr.state %}
                                        {{ addr.state }},
                                    {% endif %}
                                    {{ addr.postal_code }},
                                    {{ addr.country }}
                                    {% if addr.is_default %}
                                        (default)
                                    {% endif %}
                                </option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="w3-button w3-dark-gray w3-round w3-block">
                            Use this address</button>
                    </form>
                    </div>
                </div>
{#                    End of address choice#}
                {% endif %}
            <form action="{% url 'process-payment' %}" method="post">
                <div class="w3-container w3-padding">
                    <div class="w3-row-padding">
                        <div class="w3-col s12 w3-margin-bottom">
                            <label for="address_line1" class="w3-small"><strong>Address Line 1</strong></label>
                            <input id="address_line1" type="text" class="w3-input w3-border w3-round"
                                name="address_line1" placeholder="" value="{{ active_address.address_line1 }}" required>
                        </div>
                        <div class="w3-col s12 w3-margin-bottom">
                            <label for="address_line2" class="w3-small">Address Line 2</label>
                            <input id="address_line2" type="text" class="w3-input w3-border w3-round"
                                name="address_line2" placeholder="" value="{{ active_address.address_line2 }}">
                        </div>
                        <div class="w3-col s12 m4 w3-margin-bottom">
                            <label for="state" class="w3-small">State/Province</label>
                            <input id="state" type="text" class="w3-input w3-border w3-round" placeholder=""
                                name="state" value="{{ active_address.state }}">
                        </div>
                        <div class="w3-col s12 m4 w3-margin-bottom">
                            <label for="city" class="w3-small"><strong>City</strong></label>
                            <input id="city" type="text" class="w3-input w3-border w3-round" placeholder=""
                                name="city" value="{{ active_address.city }}" required>
                        </div>
                        <div class="w3-col s12 m4 w3-margin-bottom">
                            <label for="zip" class="w3-small"><strong>Post Code</strong></label>
                            <input id="zip" type="text" class="w3-input w3-border w3-round" placeholder=""
                                name="zip" value="{{ active_address.postal_code }}">
                        </div>
                        <div class="w3-col s12 w3-margin-bottom">
                            <label for="country" class="w3-small"><strong>Country</strong></label>
                            <select id="country" name="country" class="w3-select w3-border w3-round">
                                <option value="GB"
                                        {% if active_address.country == 'GB' %}selected{% endif %}>United Kingdom</option>
                                <option value="US"
                                        {% if active_address.country == 'US' %}selected{% endif %}>United States</option>
                                <option value="CA"
                                        {% if active_address.country == 'CA' %}selected{% endif %}>Canada</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contact Information -->
            <div class="w3-card w3-white w3-margin-bottom">
                <header class="w3-container w3-padding">
                    <h3 class="w3-margin-0">Contact Information</h3>
                </header>
                <div class="w3-container w3-padding">
                        <div class="w3-row-padding">
                            <div class="w3-col s12 m6 w3-margin-bottom">
                                <label for="first_name" class="w3-small"><strong>First Name</strong></label>
                                <input id="first_name" name="first_name" type="text" class="w3-input w3-border w3-round"
                                    placeholder="John" value="{{ profile.name }}" required>
                            </div>
                            <div class="w3-col s12 m6 w3-margin-bottom">
                                <label for="last_name" class="w3-small"><strong>Last Name</strong></label>
                                <input id="last_name" type="text" class="w3-input w3-border w3-round" placeholder="Doe"
                                    name="last_name" value="{{ profile.surname }}" required>
                            </div>
                        </div>
                </div>
            </div>

            <!-- Payment Details -->
            <div class="w3-card w3-white w3-margin-bottom">
                <header class="w3-container w3-padding">
                    <h3 class="w3-margin-0">Payment Details</h3>
                </header>
                <div class="w3-container w3-padding">
                    <div class="w3-row-padding">
                        <div class="w3-col s12 w3-margin-bottom">
                            <label for="card_number" class="w3-small"><strong>Card Number</strong></label>
                            <input id="card_number" type="text" class="w3-input w3-border w3-round"
                                name="card_number" placeholder="" required maxlength="16">
                        </div>
                        <div class="w3-col s12 m6 w3-margin-bottom">
                            <label for="expiry_month" class="w3-small"><strong>Expiry Date</strong></label><br>
                            <input id="expiry_month" name="expiry_month" type="text"
                                   class="w3-input w3-border w3-round w3-show-inline-block" placeholder="MM"
                            required maxlength="2">
                            <input id="expiry_year" type="text" name="expiry_year"
                                   class="w3-input w3-border w3-round w3-show-inline-block" placeholder="YY"
                            required maxlength="2">
                        </div>
                        <div class="w3-col s12 m6 w3-margin-bottom">
                            <label for="cvc" class="w3-small"><strong>CVC</strong></label>
                            <input id="cvc" type="text" class="w3-input w3-border w3-round" placeholder="123"
                                   name="cvc" required maxlength="3">
                        </div>
                    </div>
                </div>
            </div>

        </section>

        <!-- Order Summary -->
        <aside class="w3-col l4 m12 s12">
            <div class="w3-card w3-white sticky-summary">
                <header class="w3-container w3-padding">
                    <h3 class="w3-margin-0">Order Summary</h3>
                </header>

                <!-- Cart Items -->
                <div class="w3-container" id="cartBody">
                    {% csrf_token %}
                    {% for prod in cart_items %}
                    <div class="w3-row w3-padding-small">
                        <div class="w3-col s3">
                            <div class="thumb w3-border">
                                <img src="{{ prod.product.image.url.url }}" alt="{{ prod.product.title }}">
                            </div>
                        </div>
                        <div class="w3-col s6">
                            <strong class="w3-small">{{ prod.product.title }}</strong>
                            <div class="w3-tiny w3-text-grey">Price: <span class="item-price">
                                £{{ prod.product.price }}</span></div>
                            <div class="w3-tiny w3-text-grey">Qty: <span class="item-qty">{{ prod.qty }}</span></div>
                        </div>
                        <div class="w3-col s3 w3-right-align">
                            <div class="w3-small">£<span class="prod-line"
                                data-qty="{{ prod.qty }}" data-price="{{ prod.product.price }}">
                            </span></div>
                        </div>
                    </div>
                    <hr class="w3-margin-0">
                    {% endfor %}
                </div>

                <!-- Summary Totals -->
                <div class="w3-container">
                    <div class="w3-row w3-margin-top">
                        <div class="w3-col s6">Subtotal</div>
                        <div class="w3-col s6 w3-right-align">£<span id="subtotal">{{ subtotal }}</span></div>
                    </div>

                    <div class="w3-row w3-margin-top">
                        <div class="w3-col s6">Discount</div>
                        <div class="w3-col s6 w3-right-align">−£<span id="discount">{{ discount_value }}</span></div>
                    </div>


                    <!-- Shipping Data -->

                    <div class="w3-row w3-margin-top">
                        <div class="w3-col s6">
                            Shipping <br><span class="w3-small">{{ shipping_method_html }}</span>
                            {% if shipping_price == 0.00 %}
                                <div class="w3-small w3-text-grey">Free over £50</div>
                            {% endif %}
                        </div>
                        <div class="w3-col s6 w3-right-align">
                            £{{ shipping_price }}
                        </div>
                    </div>

                    <div class="w3-row w3-margin-top">
                        <div class="w3-col s6">incl. VAT<div class="w3-small w3-text-grey">{{ vat_percent }}%</div>
                                </div>
                        <div class="w3-col s6 w3-right-align">£<span id="vat">{{ vat_amount }}</span></div>
                    </div>

                    <hr>

                    <div class="w3-row w3-xlarge">
                        <div class="w3-col s6"><strong>Total</strong></div>
                        <div class="w3-col s6 w3-right-align"><strong>£<span id="total">{{ total }}</span>
                            </strong></div>
                    </div>

                    <div class="w3-section">
                        <input type="hidden" id="pay-action" value="{% url 'process-payment' %}">
                        <button type="submit" class="w3-button w3-red w3-round w3-block pay-button" id="pay-button">
                            <i class="fa-solid fa-lock background-color-inherit"></i> Pay Now</button>
                    </div>

                    <div class="w3-small w3-text-grey w3-margin-bottom">
                        <i class="fa-solid fa-lock"></i> Secure payment • <i class="fa-solid fa-rotate"></i> 30-day
                        returns
                    </div>
                </div>
            </div>
        </aside>

    </div>
</div>

{% endif %}

<form id="form-template">
    <input type="hidden" name="checkout_hash" value="{{ cart_hash }}">
    {% csrf_token %}
</form>

{% endblock content %}

{% block postloadjs %}
<script src="{% static 'js/checkout.js' %}"></script>
{% endblock postloadjs %}