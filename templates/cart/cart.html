{% extends '_base.html' %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/cart.css' %}">
{% endblock extra_css %}

{% block content %}

<header class="w3-bar w3-border-bottom">
  <a href="{% url 'products' %}" class="w3-bar-item w3-button">
      <i class="fa-solid fa-arrow-left background-color-inherit"></i> Continue shopping</a>
  <span class="w3-bar-item w3-right w3-large"><i class="fa-solid fa-cart-shopping"></i> Your Cart</span>
</header>

    {% if not cart_items %}
        <div class="w3-panel">
              <h3 class="w3-margin-0 w3-center">Cart is empty</h3>
        </div>
    {% else %}

<div class="w3-content page w3-padding-16">
  <div class="w3-row-padding">

    <!-- Cart items -->
    <section class="w3-col l8 m12 s12">
      <div class="w3-card w3-white">
        <header class="w3-container w3-padding">
          <h3 class="w3-margin-0">Items</h3>
        </header>

        <div id="cartBody" class="w3-container">
        {% csrf_token %}
          <!-- Row -->
          <!-- Repeat this block per item (in Django: for product in cart) -->

          {% for prod in cart_items %}

          <div class="w3-row w3-padding cart-item" data-sku="{{ prod.product.sku }}" data-price="{{ prod.product.price }}">
            <div class="w3-col s3 m2 l2">
              <div class="thumb w3-border">
                <img src="{{ prod.product.image.url.url }}" alt="{{ prod.product.title }}">
              </div>
            </div>
            <div class="w3-col s9 m10 l10">
              <div class="w3-row">
                <form method="post" action="{% url 'remove-from-cart' %}">
                    {% csrf_token %}
                    <input type="hidden" name="sku" value="{{ prod.product.sku }}">
                    <div class="w3-col s12 m7 l7">
                      <strong>{{ prod.product.title }}</strong>
                      <div class="w3-small w3-text-grey">{{ prod.product.category.title }}</div>
                      <button class="w3-button w3-small w3-border w3-round w3-margin-top">
                        <i class="fa-regular fa-trash-can background-color-inherit"></i> Remove
                      </button>
                    </div>
                </form>
                <div class="w3-col s7 m3 l3 w3-margin-top">
                  <label for="{{ prod.product.sku }}-qty" class="w3-small">Quantity</label>
                  <div class="w3-row qty">
                    <div class="w3-col s4">
                      <button id="{{ prod.product.sku }}-minus" class="w3-button w3-border w3-round w3-block">
                          −</button>
                    </div>
                    <div class="w3-col s4">
                      <input id="{{ prod.product.sku }}-qty" class="w3-input w3-border w3-center item-qty"
                             type="number" min="1" value="{{ prod.qty }}" name="product-{{ prod.product.sku }}">
                    </div>
                    <div class="w3-col s4">
                      <button id="{{ prod.product.sku }}-plus" class="w3-button w3-border w3-round w3-block">
                          +</button>
                    </div>
                  </div>
                </div>
                <div class="w3-col s5 m2 l2 w3-right-align w3-margin-top">
                  <div class="w3-small w3-text-grey">Unit</div>
                  <div>£<span class="unit">{{ prod.price }}</span></div>
                  <div class="w3-small w3-text-grey">Line</div>
                  <div><strong>£<span class="line" id="{{ prod.product.sku }}-line">18.99</span></strong></div>
                </div>
              </div>
            </div>
          </div>

          <hr>
        {% endfor %}
        </div>

        <!-- Coupon -->
        {% if coupon %}
        <div class="w3-container w3-padding w3-small" id="coupon-data" data-coupon="{{ coupon }}"
             data-coupon-type="{{ coupon.type }}" data-coupon-value="{{ coupon.value }}">
          <form method="post" action="{% url 'coupon-remove' %}" class="w3-row">
              Coupon <strong>{{ coupon }}</strong> has been applied.<br>Applying a new coupon will replace this one.<br>
              <input type="hidden" name="coupon" value="{{ coupon }}">
              {% csrf_token %}
              <button class="w3-button w3-black w3-round w3-show-inline-block" type="submit">
                  <i class="fa-solid fa-tag background-color-inherit"></i> Remove Coupon</button>
          </form>
        </div>
        {% endif %}
        <div class="w3-container w3-padding">
          <form method="post" action="{% url 'coupon-add' %}" class="w3-row">
              {% csrf_token %}
            <input type="hidden" id="cart_number" name="cart_number" value="{{ cart.cart_number }}">
            <div class="w3-col s8 m6 l6">
              <label for="coupon" class="w3-small">Coupon code</label>
              <input id="coupon" name="coupon" class="w3-input w3-border w3-round" placeholder="e.g. WELCOME10">
            </div>
            <div class="w3-col s4 m3 l3" id="coupon-apply-bt-wrapper">
              <button class="w3-button w3-black w3-round" type="submit">
                  <i class="fa-solid fa-tag background-color-inherit"></i> Apply</button>
            </div>
          </form>
        </div>
      </div>
    </section>

    <!-- Summary -->
    <aside class="w3-col l4 m12 s12">
      <div class="w3-card w3-white sticky-summary">
        <header class="w3-container w3-padding">
          <h3 class="w3-margin-0">Order Summary</h3>
        </header>
        <div class="w3-container">
          <div class="w3-row">
            <div class="w3-col s6">Subtotal</div>
            <div class="w3-col s6 w3-right-align">£<span id="subtotal">0.00</span></div>
          </div>

          <div class="w3-row w3-margin-top">
            <div class="w3-col s6">Discount</div>
            <div class="w3-col s6 w3-right-align">−£<span id="discount">0.00</span></div>
          </div>

            <!-- Shipping -->
            {% for sh in shipping %}
            <div class="ship-data" data-order="{{ forloop.counter0 }}" data-ship-code="{{ sh.code }}"
                 data-ship-text="{{ sh.text_html }}"
                 data-ship-threshold="{{ sh.discount_threshold }}"
                 data-ship-discounted-price="{{ sh.price_discounted }}"
                 data-ship-price="{{ sh.price }}"></div>
            {% endfor %}
          <div class="w3-row w3-margin-top">
            <div class="w3-col s6">
              Shipping
              <div class="w3-small w3-text-grey">Free over £50</div>
            </div>
            <div class="w3-col s6 w3-right-align">
              <select id="shipping" class="w3-select w3-border w3-round">
                  {% for sh in shipping %}
                      <option id="shipping-{{ sh.code }}" name="{{ sh.code }}"
                              {% if sh.code == cart.shipping_method %}selected{% endif %}>
                          {{ sh.text_html }} - £{{ sh.price }}</option>
                  {% endfor %}
              </select>
            </div>
          </div>

          <div class="w3-row w3-margin-top">
            <div class="w3-col s6">incl. VAT (20%)</div>
            <div class="w3-col s6 w3-right-align">£<span id="vat">0.00</span></div>
          </div>

          <hr>

          <div class="w3-row w3-xlarge">
            <div class="w3-col s6"><strong>Total</strong></div>
            <div class="w3-col s6 w3-right-align"><strong>£<span id="total">0.00</span></strong></div>
          </div>

          <div class="w3-section">
            <input type="hidden" id="cart_number" name="cart_number" value="{{ cart.cart_number }}">
            <button type="button" class="w3-button w3-black w3-round w3-block" id="update-cart-bt">
                <i class="fa-solid fa-cart-arrow-down background-color-inherit"></i> Update cart</button>
            <button class="w3-button w3-red w3-round w3-block w3-margin-top" id="checkout-bt">
                <i class="fa-solid fa-credit-card background-color-inherit"></i> Checkout</button>
          </div>

          <div class="w3-small w3-text-grey w3-margin-bottom">
            <i class="fa-solid fa-lock"></i> Secure payment • <i class="fa-solid fa-rotate"></i> 30-day returns
          </div>
        </div>
      </div>
    </aside>

  </div>
</div>

    {% endif %}


    <form id="form-template">
     {% csrf_token %}
    <input type="hidden" name="update-cart" id="update-cart" class="tech-field"
           value="{% url 'update-cart' %}">
    <input type="hidden" name="checkout" id="checkout" class="tech-field"
           value="{% url 'checkout' %}">
    </form>
{% endblock content %}

{% block postloadjs %}
        <script src="{% static 'js/cart.js' %}"></script>
{% endblock postloadjs %}